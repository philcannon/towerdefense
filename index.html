<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Phaser Tower Defense</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden;
      background: #000;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      width: 100%;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
<script>
let playerTokens = parseInt(localStorage.getItem('tokens')) || 0;

class HomeScene extends Phaser.Scene {
  constructor() {
    super('HomeScene');
  }

  create() {
    const w = this.sys.game.config.width;
    const h = this.sys.game.config.height;
    this.add.rectangle(0, 0, w * 2, h * 2, 0x0c0c0c).setOrigin(0);
    this.add.text(w / 2, 120, '⚔️ Tower Defense', { fontSize: '64px', fill: '#FFD700', fontStyle: 'bold' }).setOrigin(0.5);
    this.add.text(w / 2, 200, `💰 Tokens: ${playerTokens}`, { fontSize: '28px', fill: '#ffffff' }).setOrigin(0.5);

    const playButton = this.add.text(w / 2, 300, '▶️ Start Game', {
      fontSize: '36px', fill: '#00ffcc', backgroundColor: '#222', padding: { x: 20, y: 10 }
    }).setOrigin(0.5).setInteractive();
    playButton.on('pointerover', () => playButton.setStyle({ backgroundColor: '#444' }));
    playButton.on('pointerout', () => playButton.setStyle({ backgroundColor: '#222' }));
    playButton.on('pointerdown', () => this.scene.start('TowerDefenseScene'));

    const shopButton = this.add.text(w / 2, 380, '🛒 Shop', {
      fontSize: '30px', fill: '#ffffff', backgroundColor: '#333', padding: { x: 16, y: 8 }
    }).setOrigin(0.5).setInteractive();
    shopButton.on('pointerover', () => shopButton.setStyle({ backgroundColor: '#555' }));
    shopButton.on('pointerout', () => shopButton.setStyle({ backgroundColor: '#333' }));
    shopButton.on('pointerdown', () => this.scene.start('ShopScene'));
  }
}

class GameOverScene extends Phaser.Scene {
  constructor() {
    super('GameOverScene');
  }

  init(data) {
    this.score = data.score || 0;
    this.highScore = data.highScore || 0;
    this.tokensEarned = Math.floor(this.score / 50);
    playerTokens += this.tokensEarned;
    localStorage.setItem('tokens', playerTokens);
  }

  create() {
    const w = this.sys.game.config.width;
    const h = this.sys.game.config.height;

    this.add.rectangle(0, 0, w * 2, h * 2, 0x1a1a1a).setOrigin(0);
    this.add.text(w / 2, 120, '💀 Game Over', { fontSize: '48px', fill: '#ff4c4c' }).setOrigin(0.5);
    this.add.text(w / 2, 190, `🏆 Score: ${this.score}`, { fontSize: '26px', fill: '#ffffff' }).setOrigin(0.5);
    this.add.text(w / 2, 230, `🥇 High Score: ${this.highScore}`, { fontSize: '26px', fill: '#ffffff' }).setOrigin(0.5);
    this.add.text(w / 2, 270, `🎁 Tokens Earned: ${this.tokensEarned}`, { fontSize: '26px', fill: '#00ffcc' }).setOrigin(0.5);

    const retryBtn = this.add.text(w / 2, 340, '🔁 Play Again', {
      fontSize: '28px', fill: '#ffffff', backgroundColor: '#444', padding: { x: 20, y: 10 }
    }).setOrigin(0.5).setInteractive();
    retryBtn.on('pointerover', () => retryBtn.setStyle({ backgroundColor: '#666' }));
    retryBtn.on('pointerout', () => retryBtn.setStyle({ backgroundColor: '#444' }));
    retryBtn.on('pointerdown', () => this.scene.start('TowerDefenseScene'));

    const shopBtn = this.add.text(w / 2, 410, '🛒 Go to Shop', {
      fontSize: '24px', fill: '#00ffcc', backgroundColor: '#222', padding: { x: 16, y: 8 }
    }).setOrigin(0.5).setInteractive();
    shopBtn.on('pointerover', () => shopBtn.setStyle({ backgroundColor: '#444' }));
    shopBtn.on('pointerout', () => shopBtn.setStyle({ backgroundColor: '#222' }));
    shopBtn.on('pointerdown', () => this.scene.start('ShopScene'));
  }
}

class ShopScene extends Phaser.Scene {
  constructor() {
    super('ShopScene');
  }

  create() {
    const w = this.sys.game.config.width;
    const h = this.sys.game.config.height;

    this.add.rectangle(0, 0, w * 2, h * 2, 0x001f33).setOrigin(0);
    this.add.text(w / 2, 70, '🛒 Upgrade Shop', {
      fontSize: '40px', fill: '#ffffff'
    }).setOrigin(0.5);

    this.tokenDisplay = this.add.text(w / 2, 130, `💰 Tokens: ${playerTokens}`, {
      fontSize: '24px', fill: '#00ffcc'
    }).setOrigin(0.5);

    const upgrades = [
      { name: 'Faster Bullets', cost: 50 },
      { name: 'Increased Range', cost: 75 },
      { name: 'Double Damage', cost: 100 }
    ];

    upgrades.forEach((upgrade, i) => {
      const y = 200 + i * 80;
      const button = this.add.rectangle(w / 2, y, 300, 50, 0x114466).setOrigin(0.5).setInteractive();
      const label = this.add.text(w / 2, y, `${upgrade.name} - ${upgrade.cost} tokens`, {
        fontSize: '20px', fill: '#ffffff'
      }).setOrigin(0.5);

      button.on('pointerover', () => button.setFillStyle(0x226688));
      button.on('pointerout', () => button.setFillStyle(0x114466));
      button.on('pointerdown', () => {
        if (playerTokens >= upgrade.cost) {
          playerTokens -= upgrade.cost;
          localStorage.setItem('tokens', playerTokens);
          label.setText(`${upgrade.name} - PURCHASED`);
          this.tokenDisplay.setText(`💰 Tokens: ${playerTokens}`);
        } else {
          label.setText(`${upgrade.name} - NOT ENOUGH TOKENS`);
        }
      });
    });

    const backBtn = this.add.text(w / 2, h - 80, '⬅️ Back to Home', {
      fontSize: '24px', fill: '#ffffff', backgroundColor: '#444', padding: { x: 20, y: 10 }
    }).setOrigin(0.5).setInteractive();
    backBtn.on('pointerover', () => backBtn.setStyle({ backgroundColor: '#666' }));
    backBtn.on('pointerout', () => backBtn.setStyle({ backgroundColor: '#444' }));
    backBtn.on('pointerdown', () => this.scene.start('HomeScene'));
  }
}

class TowerDefenseScene extends Phaser.Scene {
  constructor() {
    super('TowerDefenseScene');
    this.maxHealth = 100;
    this.health = this.maxHealth;
    this.tokens = playerTokens;
    this.currentWave = 1;
    this.waveProgress = 0;
    this.selectedTowerIndex = 0;
  }

  create() {
    const w = this.sys.game.config.width;
    const h = this.sys.game.config.height;
    console.log('TowerDefenseScene started', w, h);

    // Set camera background color explicitly
    this.cameras.main.setBackgroundColor('#1a1a1a');

    // Draw a thick yellow path line for visibility
    this.drawPath();

    // Initialize game variables
    this.health = this.maxHealth;
    this.tokens = playerTokens;
    this.currentWave = 1;
    this.waveProgress = 0;

    // HUD setup
    this.createHUD();

    // Tower placement array
    this.towers = [];

    // Towers data for selection panel
    this.towerData = [
      { name: 'Basic', cost: 10, color: 0x00ccff },
      { name: 'Sniper', cost: 30, color: 0xaa00ff },
      { name: 'Splash', cost: 50, color: 0xffaa00 },
      { name: 'Freeze', cost: 40, color: 0x00ffaa },
      { name: 'Laser', cost: 70, color: 0xff0055 },
    ];

    this.createTowerSelectionPanel();

    this.selectTower(this.selectedTowerIndex);

    // Enable placing towers on click, but only above the HUD
    this.input.on('pointerdown', pointer => {
      if (pointer.y > h - 70) return; // avoid placing on HUD
      const towerData = this.towerData[this.selectedTowerIndex];
      if (this.tokens >= towerData.cost) {
        this.placeTower(pointer.x, pointer.y, towerData);
        this.tokens -= towerData.cost;
        this.updateTokens(this.tokens);
      }
    });

    // Add a test enemy moving on path for visual feedback
    this.createTestEnemy();

    // Demo wave timer for wave progress and tokens
    this.waveTimer = this.time.addEvent({
      delay: 1000,
      loop: true,
      callback: () => {
        this.waveProgress += 0.1;
        if (this.waveProgress >= 1) {
          this.currentWave++;
          this.updateWaveNumber(this.currentWave);
          this.waveProgress = 0;
          // Reward tokens for wave completion
          this.tokens += 20;
          this.updateTokens(this.tokens);
        }
        this.updateWaveProgress(this.waveProgress);
      }
    });

    // Resize handling
    window.addEventListener('resize', () => {
      this.scale.resize(window.innerWidth, window.innerHeight);
      this.cameras.resize(window.innerWidth, window.innerHeight);
      this.redrawUI();
    });
  }

  redrawUI() {
    // Redraw path and reposition HUD on resize
    this.drawPath();
    this.hudBg.setSize(this.sys.game.config.width, 70);
    this.towerPanelBg.setPosition(0, this.sys.game.config.height - 70);
    this.towerPanelBg.setSize(this.sys.game.config.width, 70);
    this.waveText.setPosition(this.sys.game.config.width / 2, 20);
    this.waveBarBg.setPosition(this.sys.game.config.width / 2 - 100, 50);
    this.waveBar.setPosition(this.sys.game.config.width / 2 - 100, 50);
    this.tokenText.setPosition(240, 20);
    this.towerIcons.forEach((icon, i) => {
      const gap = 120;
      const x = 20 + i * gap;
      icon.setPosition(x, this.sys.game.config.height - 35);
    });
  }

  drawPath() {
    if(this.pathGraphics) this.pathGraphics.clear();
    else this.pathGraphics = this.add.graphics();

    this.pathGraphics.lineStyle(8, 0xffff00);

    const w = this.sys.game.config.width;
    const h = this.sys.game.config.height;

    // Draw a bright visible curve
    this.pathGraphics.beginPath();
    this.pathGraphics.moveTo(50, h - 150);
    this.pathGraphics.cubicBezierCurveTo(w / 2, h - 300, w / 2, 100, w - 50, 150);
    this.pathGraphics.strokePath();
  }

  createTestEnemy() {
    const w = this.sys.game.config.width;
    const h = this.sys.game.config.height;

    // Remove old enemy if exists
    if (this.enemy) this.enemy.destroy();

    // Create a simple circle to move along the path visually
    this.enemy = this.add.circle(50, h - 150, 12, 0xff4444);

    this.tweenPathProgress = { t: 0 };

    this.tweens.add({
      targets: this.tweenPathProgress,
      t: 1,
      duration: 8000,
      ease: 'Linear',
      repeat: -1,
      onUpdate: () => {
        const t = this.tweenPathProgress.t;

        // Calculate position along bezier curve
        const p0 = new Phaser.Math.Vector2(50, h - 150);
        const p1 = new Phaser.Math.Vector2(w / 2, h - 300);
        const p2 = new Phaser.Math.Vector2(w / 2, 100);
        const p3 = new Phaser.Math.Vector2(w - 50, 150);

        const x = Phaser.Math.Interpolation.Bezier([p0.x, p1.x, p2.x, p3.x], t);
        const y = Phaser.Math.Interpolation.Bezier([p0.y, p1.y, p2.y, p3.y], t);

        this.enemy.setPosition(x, y);
      }
    });
  }

  createHUD() {
    const w = this.sys.game.config.width;
    const h = this.sys.game.config.height;

    // HUD background
    this.hudBg = this.add.rectangle(0, 0, w, 70, 0x222222, 0.85).setOrigin(0);

    // Health bar background
    this.healthBarBg = this.add.rectangle(20, 20, 200, 20, 0x660000).setOrigin(0, 0.5);
    // Health bar foreground
    this.healthBar = this.add.rectangle(20, 20, 200, 20, 0xff0000).setOrigin(0, 0.5);

    // Tokens display
    this.tokenText = this.add.text(240, 20, `💰 Tokens: ${this.tokens}`, { fontSize: '20px', fill: '#00ffcc' });

    // Wave text
    this.waveText = this.add.text(w / 2, 20, `Wave: ${this.currentWave}`, { fontSize: '22px', fill: '#ffffff' }).setOrigin(0.5, 0.5);

    // Wave progress bar background
    this.waveBarBg = this.add.rectangle(w / 2 - 100, 50, 200, 12, 0x444444).setOrigin(0, 0.5);
    // Wave progress bar foreground
    this.waveBar = this.add.rectangle(w / 2 - 100, 50, 0, 12, 0x00ff00).setOrigin(0, 0.5);

    // Tower selection panel background
    this.towerPanelBg = this.add.rectangle(0, h - 70, w, 70, 0x111111, 0.9).setOrigin(0);
  }

  createTowerSelectionPanel() {
    const h = this.sys.game.config.height;

    this.towerIcons = [];
    const startX = 20;
    const gap = 120;
    this.towerData.forEach((tower, i) => {
      let x = startX + i * gap;
      let icon = this.add.rectangle(x, h - 35, 80, 50, tower.color).setOrigin(0, 0.5).setInteractive();
      let costText = this.add.text(x + 40, h - 35, `💰${tower.cost}`, { fontSize: '18px', fill: '#ffffff' }).setOrigin(0.5);
      let nameText = this.add.text(x + 40, h - 55, tower.name, { fontSize: '16px', fill: '#ccc' }).setOrigin(0.5);
      icon.on('pointerdown', () => this.selectTower(i));
      icon.on('pointerover', () => icon.setStrokeStyle(2, 0xffff00));
      icon.on('pointerout', () => {
        if (this.selectedTowerIndex !== i) icon.setStrokeStyle();
      });
      this.towerIcons.push(icon);
    });
  }

  selectTower(index) {
    this.selectedTowerIndex = index;
    this.towerIcons.forEach((icon, i) => {
      if (i === index) {
        icon.setStrokeStyle(3, 0xffff00);
      } else {
        icon.setStrokeStyle();
      }
    });
  }

  placeTower(x, y, towerData) {
    // Bigger brighter towers for visibility
    const tower = this.add.rectangle(x, y, 50, 50, towerData.color).setOrigin(0.5);
    tower.setStrokeStyle(3, 0xffffff);
    this.towers.push({ sprite: tower, data: towerData });
  }

  updateHealth(newHealth) {
    this.health = Phaser.Math.Clamp(newHealth, 0, this.maxHealth);
    this.tweens.add({
      targets: this.healthBar,
      displayWidth: 200 * (this.health / this.maxHealth),
      duration: 300,
      ease: 'Power2'
    });
  }

  updateWaveProgress(progress) {
    this.waveProgress = Phaser.Math.Clamp(progress, 0, 1);
    this.waveBar.displayWidth = 200 * this.waveProgress;
  }

  updateWaveNumber(num) {
    this.currentWave = num;
    this.waveText.setText(`Wave: ${this.currentWave}`);
  }

  updateTokens(newTokens) {
    this.tokens = newTokens;
    this.tokenText.setText(`💰 Tokens: ${this.tokens}`);
    playerTokens = newTokens;
    localStorage.setItem('tokens', playerTokens);
  }

  update() {
    // Game logic updates here if needed
  }
}

// Phaser game config with fixed size at window load
window.onload = () => {
  const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    scene: [HomeScene, TowerDefenseScene, GameOverScene, ShopScene],
    scale: {
      mode: Phaser.Scale.RESIZE,
      autoCenter: Phaser.Scale.CENTER_BOTH
    }
  };

  window.game = new Phaser.Game(config);
};
</script>
</body>
</html>
